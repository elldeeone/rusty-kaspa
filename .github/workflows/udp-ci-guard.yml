name: UDP CI Guard

on:
  push:
    branches: [udp]
  pull_request:
    branches: [udp]

jobs:
  soak-and-fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CARGO_TERM_COLOR: always
    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install nightly for fuzzing
        run: rustup toolchain install nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Build soak binaries
        run: cargo build --release -p kaspad -p udp-generator

      - name: UDP soak (3 minutes @10 kbps)
        run: ./udp/tools/soak.sh --duration 180s --rate 10

      - name: Build fuzzers (frame_header)
        working-directory: components/udp-sidechannel
        run: RUSTUP_TOOLCHAIN=nightly cargo fuzz build frame_header

      - name: Build fuzzers (digest_frame)
        working-directory: components/udp-sidechannel
        run: RUSTUP_TOOLCHAIN=nightly cargo fuzz build digest_frame

      - name: Fuzz frame_header smoke (60s)
        working-directory: components/udp-sidechannel
        run: RUSTUP_TOOLCHAIN=nightly cargo fuzz run frame_header -- -max_total_time=60

      - name: Fuzz digest_frame smoke (60s)
        working-directory: components/udp-sidechannel
        run: RUSTUP_TOOLCHAIN=nightly cargo fuzz run digest_frame -- -max_total_time=60
