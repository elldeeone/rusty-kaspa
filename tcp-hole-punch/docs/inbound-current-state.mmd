graph LR
    %% =========================
    %% Application Layer
    %% =========================
    subgraph Application
        A[Adaptor]
    end

    %% =========================
    %% Core P2P Layer
    %% =========================
    subgraph "protocol/p2p"
        CH[ConnectionHandler]
        R[Router]
        Hub[Hub]
        CI[ConnectionInitializer]
    end

    %% =========================
    %% TCP Transport
    %% =========================
    subgraph "Tonic/TCP"
        TonicServerTCP[Tonic gRPC Server over TCP]
    end

    %% =========================
    %% Libp2p Transport
    %% =========================
    subgraph "components/p2p-libp2p"
        direction TB
        Lp2pSvc[Libp2pService]
        LSP{{Libp2pStreamProvider Trait}}
        SSP[SwarmStreamProvider]
        SD[SwarmDriver]
        Swarm[Libp2p Swarm]
    end

    subgraph "Tonic/Libp2p"
        TonicServerLp2p[Tonic gRPC Server over Libp2p Stream]
    end

    %% =========================
    %% TCP Inbound Path
    %% =========================
    A -->|bidirectional starts| CH
    CH -->|serve starts| TonicServerTCP
    TonicServerTCP -->|on new TCP connection, calls<br/>ConnectionHandler::message_stream| CH

    %% =========================
    %% Libp2p Inbound Path
    %% =========================
    Lp2pSvc -->|start_inbound uses| LSP
    LSP -->|is implemented by| SSP
    SSP -->|listens for inbound streams from| SD
    Swarm -->|accepts connection and gives stream to| SD
    SD -->|emits Inbound StreamEvent to| SSP
    SSP -->|returns stream to| Lp2pSvc
    Lp2pSvc -->|handler.serve_with_incoming - attach PeerID metadata| TonicServerLp2p
    TonicServerLp2p -->|on new Libp2p stream, calls<br/>ConnectionHandler::message_stream| CH

    %% =========================
    %% Common Handling Path
    %% =========================
    CH -->|message_stream - extract metadata, create| R
    R -->|NewPeer event| Hub
    Hub -->|initialize_connection| CI
    CI -->|P2P handshake & setup| R
